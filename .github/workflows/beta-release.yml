name: Beta Release on PR

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [main]

jobs:
  beta-release:
    # Solo se ha una label release:*
    if: |
      contains(github.event.pull_request.labels.*.name, 'release:major') ||
      contains(github.event.pull_request.labels.*.name, 'release:minor') ||
      contains(github.event.pull_request.labels.*.name, 'release:patch')

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npm run lint
      - run: npm run build
      - run: npm test

      - name: Calculate beta version
        id: version
        run: |
          current_version=$(jq -r .version manifest.json)
          echo "Current version: $current_version"

          # Parse version
          IFS='.' read -r major minor patch <<< "$current_version"

          # Determine bump type from labels
          labels='${{ toJSON(github.event.pull_request.labels.*.name) }}'

          if echo "$labels" | grep -q "release:major"; then
            major=$((major + 1))
            minor=0
            patch=0
            bump_type="major"
          elif echo "$labels" | grep -q "release:minor"; then
            minor=$((minor + 1))
            patch=0
            bump_type="minor"
          elif echo "$labels" | grep -q "release:patch"; then
            patch=$((patch + 1))
            bump_type="patch"
          fi

          beta_version="${major}.${minor}.${patch}"
          echo "Beta version will be: $beta_version ($bump_type)"

          echo "beta_version=$beta_version" >> $GITHUB_OUTPUT
          echo "bump_type=$bump_type" >> $GITHUB_OUTPUT

      - name: Create beta release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          beta_version="${{ steps.version.outputs.beta_version }}"
          bump_type="${{ steps.version.outputs.bump_type }}"
          pr_number="${{ github.event.pull_request.number }}"
          short_sha="${{ github.sha }}"
          short_sha="${short_sha:0:7}"

          # Versione beta: v0.5.0-beta.pr42.abc1234
          beta_tag="v${beta_version}-beta.pr${pr_number}.${short_sha}"

          echo "Creating beta release: $beta_tag"

          # Elimina release precedenti per questa PR (cleanup)
          existing_releases=$(gh release list --json tagName -q ".[].tagName" | grep "beta.pr${pr_number}" || true)
          for old_tag in $existing_releases; do
            echo "Deleting old release: $old_tag"
            gh release delete "$old_tag" --yes --cleanup-tag || true
          done

          # Crea nuova beta release
          gh release create "$beta_tag" \
            --title="üß™ v${beta_version} Beta (PR #${pr_number})" \
            --notes="## Beta Release

          This is an automated beta release for testing PR #${pr_number}.

          **Version:** \`${beta_version}\` (${bump_type} bump)
          **Commit:** \`${short_sha}\`

          ### Install with BRAT

          1. Install [BRAT](https://github.com/TfTHacker/obsidian42-brat) plugin
          2. Go to Settings ‚Üí BRAT ‚Üí Add Beta Plugin
          3. Enter: \`luca-trifilio/obsidian-smart-image-renamer\`
          4. Select version: \`${beta_tag}\`

          ---
          ‚ö†Ô∏è **This is a pre-release for testing purposes only.**" \
            --prerelease \
            main.js manifest.json styles.css

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          beta_version="${{ steps.version.outputs.beta_version }}"
          bump_type="${{ steps.version.outputs.bump_type }}"
          pr_number="${{ github.event.pull_request.number }}"
          short_sha="${{ github.sha }}"
          short_sha="${short_sha:0:7}"
          beta_tag="v${beta_version}-beta.pr${pr_number}.${short_sha}"

          # Trova e elimina commenti beta precedenti
          existing_comments=$(gh api repos/${{ github.repository }}/issues/${pr_number}/comments --jq '.[] | select(.body | contains("## üß™ Beta Release")) | .id')
          for comment_id in $existing_comments; do
            gh api repos/${{ github.repository }}/issues/comments/${comment_id} -X DELETE || true
          done

          gh pr comment "$pr_number" --body "## üß™ Beta Release Available

          A new beta has been published for testing:

          | | |
          |---|---|
          | **Tag** | \`$beta_tag\` |
          | **Version** | \`$beta_version\` ($bump_type) |
          | **Commit** | \`$short_sha\` |

          ### Install with BRAT

          1. Open BRAT settings in Obsidian
          2. Add beta plugin: \`luca-trifilio/obsidian-smart-image-renamer\`
          3. Select version: \`$beta_tag\`

          ### Direct download

          [üì¶ Download from releases](https://github.com/${{ github.repository }}/releases/tag/$beta_tag)

          ---
          *This comment is automatically updated on each push.*"
