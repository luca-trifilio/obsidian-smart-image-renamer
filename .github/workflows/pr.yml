name: PR Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [main]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Step 1: Validate release label
  validate:
    runs-on: ubuntu-latest
    outputs:
      has_label: ${{ steps.check.outputs.has_label }}
      bump_type: ${{ steps.check.outputs.bump_type }}
    steps:
      - name: Check release label
        id: check
        run: |
          labels='${{ toJSON(github.event.pull_request.labels.*.name) }}'

          if echo "$labels" | grep -q "release:major"; then
            echo "has_label=true" >> $GITHUB_OUTPUT
            echo "bump_type=major" >> $GITHUB_OUTPUT
            echo "‚úÖ Label: release:major"
          elif echo "$labels" | grep -q "release:minor"; then
            echo "has_label=true" >> $GITHUB_OUTPUT
            echo "bump_type=minor" >> $GITHUB_OUTPUT
            echo "‚úÖ Label: release:minor"
          elif echo "$labels" | grep -q "release:patch"; then
            echo "has_label=true" >> $GITHUB_OUTPUT
            echo "bump_type=patch" >> $GITHUB_OUTPUT
            echo "‚úÖ Label: release:patch"
          else
            echo "has_label=false" >> $GITHUB_OUTPUT
            echo "bump_type=" >> $GITHUB_OUTPUT
            echo "‚ùå Missing release label! Add: release:patch, release:minor, or release:major"
            exit 1
          fi

  # Step 2: Build and test
  build-test:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-build
          path: |
            main.js
            manifest.json
            styles.css
          retention-days: 1

  # Step 3: Create beta release
  beta-release:
    needs: [validate, build-test]
    if: needs.validate.outputs.has_label == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: plugin-build

      - name: Calculate beta version
        id: version
        run: |
          current_version=$(jq -r .version manifest.json)
          bump_type="${{ needs.validate.outputs.bump_type }}"

          IFS='.' read -r major minor patch <<< "$current_version"

          case "$bump_type" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          beta_version="${major}.${minor}.${patch}"
          echo "beta_version=$beta_version" >> $GITHUB_OUTPUT
          echo "Beta version: $beta_version ($bump_type)"

      - name: Create beta release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          beta_version="${{ steps.version.outputs.beta_version }}"
          bump_type="${{ needs.validate.outputs.bump_type }}"
          pr_number="${{ github.event.pull_request.number }}"
          short_sha="${GITHUB_SHA:0:7}"
          beta_tag="v${beta_version}-beta.pr${pr_number}.${short_sha}"

          echo "Creating beta release: $beta_tag"

          # Cleanup previous betas for this PR
          existing=$(gh release list --json tagName -q ".[].tagName" | grep "beta.pr${pr_number}" || true)
          for old_tag in $existing; do
            echo "Deleting old release: $old_tag"
            gh release delete "$old_tag" --yes --cleanup-tag || true
          done

          # Create new beta
          gh release create "$beta_tag" \
            --title="üß™ v${beta_version} Beta (PR #${pr_number})" \
            --notes="## Beta Release

          Automated beta for PR #${pr_number}.

          **Version:** \`${beta_version}\` (${bump_type})
          **Commit:** \`${short_sha}\`

          ### Install with BRAT

          1. Install [BRAT](https://github.com/TfTHacker/obsidian42-brat)
          2. Settings ‚Üí BRAT ‚Üí Add Beta Plugin
          3. Enter: \`luca-trifilio/obsidian-smart-image-renamer\`
          4. Select: \`${beta_tag}\`

          ---
          ‚ö†Ô∏è Pre-release for testing only." \
            --prerelease \
            main.js manifest.json styles.css

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          beta_version="${{ steps.version.outputs.beta_version }}"
          bump_type="${{ needs.validate.outputs.bump_type }}"
          pr_number="${{ github.event.pull_request.number }}"
          short_sha="${GITHUB_SHA:0:7}"
          beta_tag="v${beta_version}-beta.pr${pr_number}.${short_sha}"

          # Delete previous beta comments
          existing=$(gh api repos/${{ github.repository }}/issues/${pr_number}/comments \
            --jq '.[] | select(.body | contains("## üß™ Beta Release")) | .id')
          for cid in $existing; do
            gh api repos/${{ github.repository }}/issues/comments/${cid} -X DELETE || true
          done

          gh pr comment "$pr_number" --body "## üß™ Beta Release Available

          | | |
          |---|---|
          | **Tag** | \`$beta_tag\` |
          | **Version** | \`$beta_version\` ($bump_type) |
          | **Commit** | \`$short_sha\` |

          ### Install with BRAT
          \`\`\`
          luca-trifilio/obsidian-smart-image-renamer
          \`\`\`
          Select version: \`$beta_tag\`

          [üì¶ Download](https://github.com/${{ github.repository }}/releases/tag/$beta_tag)

          ---
          *Auto-updated on each push.*"
