name: Cleanup Beta Releases

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Delete beta releases for this PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ github.event.pull_request.number }}"

          echo "Cleaning up beta releases for PR #${pr_number}..."

          releases=$(gh release list --repo ${{ github.repository }} --json tagName -q ".[].tagName" | grep "beta.pr${pr_number}" || true)

          if [ -z "$releases" ]; then
            echo "No beta releases found for PR #${pr_number}"
            exit 0
          fi

          for tag in $releases; do
            echo "Deleting: $tag"
            gh release delete "$tag" --repo ${{ github.repository }} --yes --cleanup-tag || true
          done

          echo "Cleanup completed!"
