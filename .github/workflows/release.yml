name: Release Pipeline

on:
  pull_request:
    types: [closed]
    branches: [main]

concurrency:
  group: release-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Cleanup betas when PR is closed (merged or not)
  cleanup-betas:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Cleanup beta releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ github.event.pull_request.number }}"
          echo "Cleaning up betas for PR #${pr_number}"

          existing=$(gh release list --repo ${{ github.repository }} --json tagName -q ".[].tagName" | grep "beta.pr${pr_number}" || true)
          if [ -z "$existing" ]; then
            echo "No beta releases found"
            exit 0
          fi

          for tag in $existing; do
            echo "Deleting: $tag"
            gh release delete "$tag" --repo ${{ github.repository }} --yes --cleanup-tag || true
          done

  # Check if release is needed
  check-release:
    # Skip if PR is from a release branch (to avoid double trigger)
    if: |
      github.event.pull_request.merged == true &&
      !startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      bump_type: ${{ steps.check.outputs.bump_type }}
    steps:
      - name: Check release label
        id: check
        run: |
          labels='${{ toJSON(github.event.pull_request.labels.*.name) }}'

          if echo "$labels" | grep -q "release:major"; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "bump_type=major" >> $GITHUB_OUTPUT
          elif echo "$labels" | grep -q "release:minor"; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          elif echo "$labels" | grep -q "release:patch"; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "No release label - skipping release"
          fi

  # Release only when PR is merged AND has release label
  release:
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Bump version
        id: version
        run: |
          npm version ${{ needs.check-release.outputs.bump_type }} --no-git-tag-version
          new_version=$(jq -r .version package.json)
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "New version: $new_version"

      - name: Update manifest and versions.json
        run: |
          new_version="${{ steps.version.outputs.new_version }}"

          # Update manifest.json
          jq ".version = \"$new_version\"" manifest.json > tmp.json && mv tmp.json manifest.json

          # Update versions.json
          min_app_version=$(jq -r .minAppVersion manifest.json)
          jq ". + {\"$new_version\": \"$min_app_version\"}" versions.json > tmp.json && mv tmp.json versions.json

      - name: Build
        run: npm run build

      - name: Create release branch and PR
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          new_version="${{ steps.version.outputs.new_version }}"
          bump_type="${{ needs.check-release.outputs.bump_type }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"
          release_branch="release/${new_version}"

          # Create release branch
          git checkout -b "$release_branch"

          # Commit version bump
          git add package.json package-lock.json manifest.json versions.json
          git commit -m "chore: release ${new_version}"

          # Push release branch
          git push origin "$release_branch"

          # Create PR with auto-merge
          pr_url=$(gh pr create \
            --title "chore: release ${new_version}" \
            --body "## Automated Release

          Bumps version to \`${new_version}\` (${bump_type}).

          Triggered by: ${pr_title} (#${pr_number})

          ---
          *This PR will be auto-merged when checks pass.*" \
            --base main \
            --head "$release_branch")

          echo "pr_url=$pr_url" >> $GITHUB_OUTPUT
          echo "Created PR: $pr_url"

          # Enable auto-merge
          gh pr merge "$release_branch" --auto --squash

      - name: Wait for PR to be merged
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_branch="release/${{ steps.version.outputs.new_version }}"
          echo "Waiting for PR to be merged..."

          # Poll every 30 seconds for up to 10 minutes
          for i in {1..20}; do
            state=$(gh pr view "$release_branch" --json state -q '.state')
            echo "PR state: $state (attempt $i/20)"

            if [ "$state" = "MERGED" ]; then
              echo "PR merged successfully!"
              exit 0
            elif [ "$state" = "CLOSED" ]; then
              echo "PR was closed without merging!"
              exit 1
            fi

            sleep 30
          done

          echo "Timeout waiting for PR to be merged"
          exit 1

      - name: Create tag and GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          new_version="${{ steps.version.outputs.new_version }}"
          bump_type="${{ needs.check-release.outputs.bump_type }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"

          # Fetch latest main (with the merged PR)
          git fetch origin main
          git checkout main
          git pull origin main

          # Create and push tag
          git tag -m "$new_version" "$new_version"
          git push origin "$new_version"

          # Get previous tag for changelog
          previous_tag=$(git describe --tags --abbrev=0 "$new_version^" 2>/dev/null || echo "")

          if [ -n "$previous_tag" ]; then
            changelog_link="[Full Changelog](https://github.com/${{ github.repository }}/compare/${previous_tag}...${new_version})"
          else
            changelog_link=""
          fi

          # Create GitHub release
          gh release create "$new_version" \
            --title="$new_version" \
            --notes="## What's Changed

          ${pr_title} (#${pr_number})

          **Version bump:** ${bump_type}

          ---
          ${changelog_link}" \
            main.js manifest.json styles.css
